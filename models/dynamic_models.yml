version: 2

dynamic_models:
  - name: '{customer}__{model}'
    location: models/customers/{customer_env}/cdm_{customer}/
    params:
      - name: customer
        query: |
          SELECT
            LOWER(CUSTOMER) AS CUSTOMER,
            LOWER(CUSTOMER_ENV) AS CUSTOMER_ENV
          FROM int."INT__DISTINCT_CUSTOMERS"
      - name: model
        query: |
          SELECT
            LOWER(table_name) AS TABLE_NAME
          FROM INFORMATION_SCHEMA.TABLES
          WHERE LOWER(TABLE_SCHEMA) = LOWER('CDM')
            AND TABLE_TYPE IN ('BASE TABLE', 'VIEW')
          ORDER BY TABLE_NAME
    sql: |
      {{{{ customer_model('{model}', '{customer}') }}}}